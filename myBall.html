<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <style>
        /* body {
            width: 300px;
        } */
        
        .ball {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 1px solid black;
            border-radius: 50%;
            background-color: black;
        }
    </style>
</head>

<body>
    <div id="div1" class="ball myDiv">


    </div>
    <script>
        const easing = "easeInOutSine";
        const c_className = "className"; // const className
        const distance = 20;
        const borderX = 200;
        const borderY = 1000;
        let funMap = new Map();

        function setFun() {
            funMap.set("addNewPlayer", addNewPlayer);
            funMap.set("delPlayer", delPlayer);
            funMap.set("moveRight", moveRight);
            funMap.set("moveLeft", moveLeft);
            funMap.set("moveTop", moveTop);
            funMap.set("moveDown", moveDown);
        }

        function getId(idName) {
            return document.getElementById(idName)
        }

        function getClass(className) {
            // className = '.' + className;
            let s = document.getElementsByClassName(className)
            console.log(s)
            console.log(s[0])
            console.log(document.querySelector('.' + className))
            return s[0];
        }

        const url = 'ws://127.0.0.1:8080'
        const socket = new WebSocket(url);

        // Listen for messages
        socket.addEventListener('message', function(event) {
            console.log('Message from server ', event.data);
            let data = JSON.parse(event.data)
            console.log(data)

            if (!funMap.has(data["methods"])) {
                console.log("server send methods error");
                return;
            }
            funMap.get(data["methods"])(data);
        });

        function delPlayer(data) {
            let d = getId(data["className"]);
            d.parentNode.removeChild(d);
        }

        function addNewPlayer(data) {
            let ball = document.createElement("div");
            ball.setAttribute("class", "ball");
            ball.classList.add(data["className"]);
            ball.setAttribute("id", data["className"]);
            document.body.appendChild(ball);
        }

        function send(data) {
            if (socket.OPEN) {
                socket.send(JSON.stringify(data));
            }
        }

        function getOffetNumX(el) {
            var style = window.getComputedStyle(el);
            var matrix = new WebKitCSSMatrix(style.transform);
            // console.log(matrix)
            return matrix.m41
        }

        function getOffetNumY(el) {
            var style = window.getComputedStyle(el);
            var matrix = new WebKitCSSMatrix(style.transform);
            // console.log(matrix)
            return matrix.m42
        }

        function moveRight(data) {
            let className = data[c_className];
            console.log(className)
            let element = getClass(className);

            let x = Number(getOffetNumX(element));
            let offsetX = x;
            console.log(x)
            if (x >= borderX) {
                return 0;
            } else
            if (x + distance > borderX) { // >= borderX
                offsetX = borderX
            } else {
                offsetX += distance
            }
            anime({
                targets: element,
                // translateX: "+=" + x,
                translateX: offsetX,
                direction: easing,
            })
            return offsetX - x
        }

        function moveLeft(data) {
            let className = data[c_className];
            let element = getClass(className);

            let x = Number(getOffetNumX(element));
            let offsetX = x;
            console.log(x)
            if (x <= 0) {
                return 0;
            } else if (x - distance <= 0) { // >= borderX
                offsetX = 0
            } else {
                offsetX -= distance
            }

            anime({
                targets: element,
                translateX: offsetX,
                direction: easing,
            })

            return offsetX - x;
        }

        function moveTop(data) {
            let className = data[c_className];
            let element = getClass(className);

            anime({
                targets: element,
                translateY: "-=" + distance,
                direction: easing,
            })
        }

        function moveDown(data) {
            let className = data[c_className];
            let element = getClass(className);

            anime({
                targets: element,
                translateY: "+=" + distance,
                direction: easing,
            })
        }
        setFun();

        $(document).keyup(function(event) {
            let code = String.fromCharCode(event.keyCode);
            const data = {
                "methods": "moveRight",
                "distance": distance,
                "className": "myDiv"
            };

            let offset = 0;

            if (code === 'd' || code === 'D') {
                offset = moveRight(data);
            } else if (code === 'a' || code === 'A') {
                offset = moveLeft(data);
                data["methods"] = "moveLeft";
            } else if (code === 'w' || code === 'W') {
                offset = moveTop(data);
                data["methods"] = "moveTop";
            } else if (code === 's' || code === 'S') {
                offset = moveDown(data);
                data["methods"] = "moveDown";
            } else {
                console.log("错误按键");
                return;
            }
            if (offset === 0) {
                return;
            }

            data["distance"] = offset;
            send(data);
        });
    </script>
</body>

</html>